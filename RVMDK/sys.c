#include "sys.h"
#include "core_cm3.h"
//////////////////////////////////////////////////////////////////////////////////	 
//???????????'?ã?d????????????????????????????;
//ALIENTEK  STM32??????
//???????????û?		   
//???????@ALIENTEK
//???????:www.openedv.com
//???????:2012/9/10
//????V1.4
//????????????????
//Copyright(C) ??????? 2009-2019
//All rights reserved
//********************************************************************************  
//THUMB????????????
//???????·??????????????WFI  
void WFI_SET(void)
{
	__ASM volatile("wfi");		  
}
//??????????
void INTX_DISABLE(void)
{		  
	__ASM volatile("cpsid i");
}
//???????????
void INTX_ENABLE(void)
{
	__ASM volatile("cpsie i");		  
}
//??????????
//addr:??????
__asm void MSR_MSP(u32 addr) 
{
    MSR MSP, r0 			//set Main Stack value
    BX r14
}

//static u8  fac_us=0;							//us?????????			
//void delay_us(u32 nus)
//{		
//		int i,cnt ;
//		cnt = nus<<1  ;
//		for ( i = 0 ; i < cnt ; i++ );
//	
//}
////???nms
////???nms?k??
////SysTick->LOAD?24??J???,????,???????:
////nms<=0xffffff*8*1000/SYSCLK
////SYSCLK????Hz,nms????ms
////??72M??????,nms<=1864 
//void delay_ms(u16 nms)
//{	 		  	  
//	int i ;
//	for( i = 0 ; i < nms; i ++ )
//		delay_us(1000) ;
//} 

static u8  fac_us=9;//us?????????
static u16 fac_ms= 9000;//ms?????????
//??'????????
//SYSTICK????????HCLK????1/8
//SYSCLK:?????
void delay_init(u8 SYSCLK)
{
//	SysTick->CTRL&=0xfffffffb;//bit2???,????????  HCLK/8
	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK_Div8);	//????????  HCLK/8
	fac_us=SYSCLK/8;		    
	fac_ms=(u16)fac_us*1000;
}								    
//???nms
//???nms?k??
//SysTick->LOAD?24??J???,????,???????:
//nms<=0xffffff*8*1000/SYSCLK
//SYSCLK????Hz,nms????ms
//??72M??????,nms<=1864 
void delay_ms(u16 nms)
{	 		  	  
	u32 temp;		   
	SysTick->LOAD=(u32)nms*fac_ms;//??????(SysTick->LOAD?24bit)
	SysTick->VAL =0x00;           //????????
	SysTick->CTRL=0x01 ;          //??'????  
	do
	{
		temp=SysTick->CTRL;
	}
	while(temp&0x01&&!(temp&(1<<16)));//????????   
	SysTick->CTRL=0x00;       //????????
	SysTick->VAL =0X00;       //????????	  	    
}   

void delay_s(u16 ns) //????delay_ms?????1864????????????L????ñ?????
{
   u16 i=0;
   for(i=0;i<ns;i++)
    delay_ms(1000);

}
//???nus
//nus???????us??.		    								   
void delay_us(u32 nus)
{		
	u32 temp;	    	 
	SysTick->LOAD=nus*fac_us; //??????	  		 
	SysTick->VAL=0x00;        //????????
	SysTick->CTRL=0x01 ;      //??'???? 	 
	do
	{
		temp=SysTick->CTRL;
	}
	while(temp&0x01&&!(temp&(1<<16)));//????????   
	SysTick->CTRL=0x00;       //????????
	SysTick->VAL =0X00;       //????????	 
}
//static u8  fac_us=0;							//usÑÓÊ±±¶³ËÊý			
void delay_us2(u32 nus)
{		
		int i,cnt ;
		cnt = nus<<1  ;
		for ( i = 0 ; i < cnt ; i++ );
	
}
//ÑÓÊ±nms
//×¢ÒânmsµÄ·¶Î§
//SysTick->LOADÎª24Î»¼Ä´æÆ÷,ËùÒÔ,×î´óÑÓÊ±Îª:
//nms<=0xffffff*8*1000/SYSCLK
//SYSCLKµ¥Î»ÎªHz,nmsµ¥Î»Îªms
//¶Ô72MÌõ¼þÏÂ,nms<=1864 
void delay_ms2(u16 nms)
{	 		  	  
	int i ;
	for( i = 0 ; i < nms; i ++ )
		delay_us2(100) ;
} 

